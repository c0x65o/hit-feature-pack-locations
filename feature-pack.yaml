# Feature Pack: locations
# Locations management with hierarchical structure, user assignments, maps, and geocoding

name: locations
description: Locations feature pack with hierarchical locations, user assignments, map visualization, and geocoding

# Route definitions - mapped to React components
# IMPORTANT: Static routes must come before dynamic [id] routes to prevent incorrect matching
routes:
  - path: /locations
    page: Dashboard
    roles: [admin]  # Admin only
  - path: /locations/list
    page: LocationList
    roles: [admin]
  - path: /locations/new
    page: LocationEdit
    roles: [admin]
  - path: /locations/types
    page: LocationTypes
    roles: [admin]
  - path: /locations/users
    page: LocationUserAssociations
    roles: [admin]
  - path: /locations/[id]
    page: LocationDetail
    roles: [admin]
  - path: /locations/[id]/edit
    page: LocationEdit
    roles: [admin]

# Navigation contributions - auto-added to shell sidebar
nav:
  - id: locations
    label: Locations
    path: /locations
    icon: MapPin
    group: system  # System/admin tools
    roles: [admin]
    showWhen: authenticated
    weight: 920  # System area, after tasks/metrics
    children:
      - id: locations-dashboard
        label: Dashboard
        path: /locations
        icon: LayoutDashboard
        weight: 100
        showWhen: authenticated
        roles: [admin]
      - id: locations-list
        label: All Locations
        path: /locations/list
        icon: MapPin
        weight: 110
        showWhen: authenticated
        roles: [admin]
      - id: locations-types
        label: Location Types
        path: /locations/types
        icon: Tag
        weight: 120
        showWhen: authenticated
        roles: [admin]
      - id: locations-users
        label: User Associations
        path: /locations/users
        icon: Users
        weight: 130
        showWhen: authenticated
        roles: [admin]

# Schema contributions (Drizzle tables)
# Projects import these into their schema
schema:
  source: src/schema/locations.ts
  exports: [locationTypes, locations, locationUserMemberships, LocationType, InsertLocationType, UpdateLocationType, Location, InsertLocation, UpdateLocation, LocationUserMembership, InsertLocationUserMembership, UpdateLocationUserMembership, DEFAULT_LOCATION_TYPES]

# API routes - handler-based pattern (recommended)
api:
  routes:
    - path: /api/locations
      methods: [GET, POST]
      handler: "@hit/feature-pack-locations/server/api/locations"
      description: "List locations (GET) or create location (POST)"
    - path: /api/locations/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-locations/server/api/locations-id"
      description: "Get, update, or delete a specific location"
    - path: /api/locations/tree
      methods: [GET]
      handler: "@hit/feature-pack-locations/server/api/tree"
      description: "Get locations in hierarchical tree structure"
    - path: /api/locations/[id]/set-primary
      methods: [POST]
      handler: "@hit/feature-pack-locations/server/api/set-primary"
      description: "Set location as the primary/HQ location"
    - path: /api/locations/types
      methods: [GET, POST]
      handler: "@hit/feature-pack-locations/server/api/types"
      description: "List location types (GET) or create type (POST)"
    - path: /api/locations/types/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-locations/server/api/types-id"
      description: "Get, update, or delete a specific location type"
    - path: /api/locations/memberships
      methods: [GET, POST]
      handler: "@hit/feature-pack-locations/server/api/memberships"
      description: "Get location memberships (GET) or assign user to location (POST). GET supports ?locationId=xxx and ?all=true (admin) filters"
    - path: /api/locations/memberships/[id]
      methods: [DELETE]
      handler: "@hit/feature-pack-locations/server/api/memberships-id"
      description: "Remove user from location"
    - path: /api/locations/[id]/memberships
      methods: [GET]
      handler: "@hit/feature-pack-locations/server/api/location-memberships"
      description: "Get all users assigned to a specific location"
    - path: /api/locations/geocode
      methods: [POST]
      handler: "@hit/feature-pack-locations/server/api/geocode"
      description: "Geocode address to latitude/longitude"
    - path: /api/user-directory
      methods: [GET]
      description: "User directory endpoint (app-level). Returns { enabled: true, users: [...] } if auth module exists, or { enabled: false } if not. Supports ?search=xxx and ?limit=N. Enables user autocomplete and 'missing users' features."
      optional: true

# No hard module dependencies - runs on project's own database
# Optional: Uses auth module via /api/user-directory for enhanced features
requires:
  modules: []
  optional_modules:
    - name: auth
      description: "Enables user autocomplete and 'missing users' detection. Without auth, users must be entered manually by email."

# Dependencies on other feature packs
dependencies:
  feature_packs:
    - name: dashboard-shell

# Configurable options
config:
  schema:
    hierarchical_enabled:
      type: boolean
      default: true
      description: "Enable hierarchical parent/child location relationships"
    map_enabled:
      type: boolean
      default: true
      description: "Enable map visualization for locations"
    geocoding_enabled:
      type: boolean
      default: true
      description: "Enable automatic geocoding of addresses to coordinates"
    geocoding_provider:
      type: string
      default: "nominatim"
      enum: [nominatim, google]
      description: "Geocoding provider (nominatim is free, google requires API key)"
    require_location_on_signup:
      type: boolean
      default: false
      description: "Require location selection during user signup"
    default_new_user_strategy:
      type: string
      default: "primary"
      enum: [primary, first_location, none]
      description: "Strategy for assigning default location to new users (primary=HQ location, first_location=first active location, none=no auto-assignment)"
    allow_multiple_user_locations:
      type: boolean
      default: true
      description: "Allow users to be assigned to multiple locations"
